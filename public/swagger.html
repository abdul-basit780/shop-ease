<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>API Docs</title>
  <link rel="stylesheet" href="swagger/swagger-ui.css" />
</head>

<body>
  <div id="swagger-ui"></div>
  <script src="swagger/swagger-ui-bundle.js"></script>
  <script src="swagger/swagger-ui-standalone-preset.js"></script>
  <script>
    // Function to detect current server based on URL
    function getCurrentServer() {
      const hostname = window.location.hostname;
      const protocol = window.location.protocol;
      const port = window.location.port;

      // Check for localhost/development
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return `${protocol}//${hostname}:${port || '3000'}`;
      }

      // Check for production domains
      if (hostname.includes('shop-ease-online-app.vercel.app') || hostname.includes('vercel.app')) {
        return 'https://shop-ease-online-app.vercel.app';
      }

      // Check for staging/preview environments
      if (hostname.includes('staging') || hostname.includes('preview')) {
        return `${protocol}//${hostname}`;
      }

      // Default fallback - use current domain
      return `${protocol}//${hostname}${port ? ':' + port : ''}`;
    }

    // Function to modify swagger.json with dynamic server
    async function loadSwaggerWithDynamicServer() {
      try {
        // Fetch the original swagger.json
        const response = await fetch('/api/docs/swagger.json');
        const swaggerSpec = await response.json();

        // Get current server
        const currentServer = getCurrentServer();

        // Update servers array to include current server at the top
        const servers = [
          {
            url: currentServer,
            description: "Current Environment"
          }
        ];

        // Add original servers if they exist and are different
        if (swaggerSpec.servers) {
          swaggerSpec.servers.forEach(server => {
            if (server.url !== currentServer) {
              servers.push(server);
            }
          });
        }

        // Add common servers if not already present
        const commonServers = [
          {
            url: "http://localhost:3000",
            description: "Development server"
          },
          {
            url: "https://shop-ease-online-app.vercel.app",
            description: "Production server"
          }
        ];

        commonServers.forEach(commonServer => {
          if (!servers.some(s => s.url === commonServer.url)) {
            servers.push(commonServer);
          }
        });

        // Update the spec
        swaggerSpec.servers = servers;

        // Initialize Swagger UI with modified spec
        SwaggerUIBundle({
          spec: swaggerSpec,
          dom_id: '#swagger-ui',
          presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
          layout: 'StandaloneLayout',
          deepLinking: true,
          displayOperationId: false,
          showExtensions: true,
          showCommonExtensions: true,
          tryItOutEnabled: true,
          requestInterceptor: (request) => {
            // Log requests for debugging
            console.log('API Request:', request);
            return request;
          },
          responseInterceptor: (response) => {
            // Log responses for debugging
            console.log('API Response:', response);
            return response;
          }
        });

        console.log('Swagger UI loaded with current server:', currentServer);

      } catch (error) {
        console.error('Error loading swagger.json:', error);

        // Fallback to original implementation if fetch fails
        SwaggerUIBundle({
          url: '/api/docs/swagger.json',
          dom_id: '#swagger-ui',
          presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
          layout: 'StandaloneLayout'
        });
      }
    }

    // Load swagger documentation with dynamic server detection
    loadSwaggerWithDynamicServer();
  </script>
</body>

</html>